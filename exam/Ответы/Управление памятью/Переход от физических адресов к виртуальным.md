#### **Почему ОС не может «просто включить виртуальную память» без предварительной подготовки структур данных? ⭐⭐**

Операционная система не может активировать виртуальную память мгновенно, так как аппаратный блок **MMU (Memory Management Unit)** требует наличия в оперативной памяти специальных структур — **таблиц страниц**. Эти таблицы служат «инструкцией» для процессора, объясняя, как именно сопоставлять логические адреса с физическими ячейками. Без заранее подготовленных и заполненных таблиц при первой же попытке процессора считать следующую инструкцию после включения страничной адресации произойдет критический сбой, так как механизм трансляции не найдет нужных данных для работы.

---

#### **Какие практические проблемы возникают, если процессор до включения paging продолжает исполнять код, но адреса уже интерпретируются иначе? ⭐⭐⭐**

Если включить режим страничной адресации (paging) без специальной подготовки, процессор начнет интерпретировать текущий адрес указателя команд (PC) как виртуальный. Без **identity mapping** (тождественного отображения) этот виртуальный адрес может указывать на совершенно иной физический фрейм или на пустую область, что приведет к немедленному **page fault** или выполнению случайного «мусора» вместо кода ОС. Кроме того, современный процессор имеет конвейер с уже декодированными инструкциями, которые были выбраны на основе старой физической карты памяти; их выполнение после смены режима адресации приведет к непредсказуемому поведению системы.

---

#### **Что меняется в модели исполнения программы, когда «все обращения к памяти становятся виртуальными»? ⭐⭐**

С этого момента программа перестает работать напрямую с аппаратными шинами памяти и переходит в «иллюзорное» **адресное пространство**. Каждый адрес, генерируемый инструкцией, теперь перехватывается MMU, который делит его на номер страницы и смещение. Программа может считать, что она занимает непрерывный блок памяти с адреса 0, в то время как физически её страницы могут быть разбросаны по всей RAM или даже частично находиться на диске.

---

#### **Почему переход к виртуальной памяти считается «точкой невозврата» в ранней загрузке ОС? ⭐⭐**

Переход к виртуальной памяти является критическим моментом, так как он радикально меняет логику работы процессора с ресурсами. После установки управляющих битов процессор выполняет **сброс конвейера (pipeline flush)** и очистку **TLB**, что делает все предыдущие трансляции и предвыборки недействительными. Если на этом этапе в таблицах страниц допущена ошибка, система уйдет в циклическую перезагрузку или «панику», так как код самой ОС станет недоступен для исполнения.

---

#### **Какие минимальные условия должны быть выполнены, чтобы переход в виртуальный режим не привёл к мгновенному краху системы? ⭐⭐⭐**

Для успешного перехода должны быть соблюдены три условия:

1. В физической памяти должны быть созданы корректные **таблицы страниц**.
2. Регистр **CR3** должен быть загружен физическим адресом корня этих таблиц.
3. Должно быть настроено **identity mapping** — отображение, при котором виртуальный адрес критического кода загрузки в точности совпадает с его физическим адресом.

---

#### **Опишите пошагово, как ОС готовит таблицу страниц до включения paging и почему она должна содержать физические адреса. ⭐⭐⭐**

Подготовка включает следующие этапы:

1. Выделение в RAM свободных фреймов под структуры таблиц (например, PML4, PDPT и др.).
2. Заполнение записей (PTE) номерами **физических фреймов**, где будет располагаться код и данные.
3. Установка служебных битов (Present=1, R/W и т.д.). Таблицы обязаны содержать именно физические адреса, так как в момент их подготовки и первой обработки процессором (MMU) механизм виртуальной трансляции еще отключен, и «железо» понимает только прямые обращения к RAM.

---

#### **Почему в CR3 содержится физический, а не виртуальный адрес? ⭐⭐**

Регистр **CR3** является отправной точкой для всего процесса трансляции адресов. Поскольку MMU использует значение этого регистра именно для того, чтобы _начать_ перевод виртуального адреса в физический, сам адрес корня таблиц не может быть виртуальным — это создало бы бесконечную рекурсию («чтобы узнать адрес таблицы, нужно сначала обратиться к этой таблице»).

---

#### **Что означает установка бита PG в CR0 и как это меняет путь адреса от инструкции до памяти? ⭐⭐**

Установка бита **PG (Paging)** в регистре CR0 активирует логику страничного преобразования внутри процессора. До этого адреса из инструкций шли напрямую на шину памяти; теперь они поступают в MMU. Там адрес разбивается на части, используется как индекс для поиска в иерархии таблиц страниц в RAM, и только после получения физического номера фрейма итоговый сигнал уходит к чипам памяти.

---

#### **Какие ошибки проектирования таблицы страниц чаще всего приводят к падению сразу после включения PG? ⭐⭐⭐**

К наиболее частым ошибкам относятся:

- Отсутствие **identity mapping** для кода, выполняющего переключение.
- Указание неверных (несуществующих) физических адресов в записях таблиц.
- Ошибки в правах доступа, когда страницы ядра помечаются как отсутствующие или только для чтения, что вызывает **page fault** при попытке записи системных данных.

---

#### **Зачем в ранней фазе загрузки нужен минимальный набор отображений страниц, даже если позже карта памяти будет совсем другой? ⭐⭐**

Минимальный набор отображений нужен для обеспечения стабильности самой процедуры загрузки ОС. Он служит временным «каркасом», позволяющим ядру инициализировать более сложные подсистемы и драйверы. Как только основная логика менеджера памяти будет запущена, ОС сможет динамически перестроить таблицы страниц под полноценную модель с разделением на kernel space и user space.

---

#### **Как бы вы объяснили смысл identity mapping человеку, который знает только «виртуальные адреса — это иллюзия»? ⭐⭐**

Identity mapping — это ситуация, когда «иллюзия» на время становится идентичной реальности. Это специальный режим настройки, при котором номер виртуальной страницы совпадает с номером физического фрейма (адрес $X$ переходит в адрес $X$). Это необходимо, чтобы процессор не «потерялся» в момент надевания «очков виртуальности»: он продолжает видеть ту же самую инструкцию по тому же самому адресу, по которому видел её мгновение назад в физическом режиме.

---

#### **Почему identity mapping часто рассматривают как «мост» между физическим и виртуальным миром, и какие свойства у этого моста? ⭐⭐⭐**

Identity mapping называют «мостом», потому что он обеспечивает **непрерывность исполнения кода** в момент перехода из одного режима в другой. **Свойства этого моста:**

- **Согласованность:** гарантирует, что следующая инструкция после включения PG будет успешно выбрана.
- **Временность:** обычно он существует только в фазе загрузки и демонтируется после того, как ядро ОС полностью перейдет в свой виртуальный диапазон адресов.
- **Прозрачность:** позволяет коду не менять свою логику при смене аппаратного режима адресации.